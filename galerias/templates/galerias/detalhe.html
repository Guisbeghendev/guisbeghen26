{% extends 'base.html' %}
{% load static %}

{% block title %}{{ galeria.titulo }} | Guisbeghen{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <header class="mb-8 border-b border-silver/10 pb-6">
        <a href="{% url 'galerias:index' %}?trilha={{ trilha }}" class="text-silver hover:text-white text-xs uppercase tracking-widest mb-4 inline-block transition-colors">
            <i class="fas fa-chevron-left mr-2"></i> Voltar para {{ galeria.categoria.nome }}
        </a>

        <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h1 class="text-3xl md:text-5xl font-bold text-white uppercase tracking-tighter leading-tight">{{ galeria.titulo }}</h1>
                <div class="flex flex-wrap items-center gap-4 mt-4 text-silver text-xs uppercase tracking-widest">
                    <span><i class="fas fa-camera-retro text-primary-purple mr-2"></i>{{ galeria.fotografo.get_full_name|default:galeria.fotografo.username }}</span>
                    <span><i class="fas fa-calendar-day text-primary-purple mr-2"></i>{{ galeria.data_evento|date:"d/m/Y" }}</span>
                    <span id="galeria-total-curtidas"><i class="fas fa-heart text-primary-purple mr-2"></i>{{ total_curtidas }} Curtidas</span>
                </div>
            </div>

            <div>
                <span class="bg-surface border border-silver/20 text-white text-xs px-4 py-2 rounded-full font-bold uppercase tracking-widest">
                    {% if trilha == 'publica' %}Acesso Público{% else %}Conteúdo Exclusivo{% endif %}
                </span>
            </div>
        </div>
    </header>

    {% if midias %}
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="gallery-grid">
        {% for midia in midias %}
        <div class="relative group bg-surface rounded overflow-hidden border border-silver/10 hover:border-primary-purple transition-all">
            <a href="{{ midia.url_exibicao }}" data-lightbox="galeria-{{ galeria.id }}" data-title="Foto #{{ midia.id }}" class="block aspect-square overflow-hidden">
                <img src="{{ midia.url_thumb }}" alt="Foto da galeria" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
            </a>

            <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-black/90 to-transparent flex justify-between items-center opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                {% if user.is_authenticated %}
                <button
                    onclick="toggleCurtida(this, {{ midia.id }})"
                    class="btn-curtida focus:outline-none transition-colors {% if midia.usuario_curtiu %}text-primary-purple{% else %}text-white{% endif %}"
                    title="Curtir foto"
                >
                    <i class="{% if midia.usuario_curtiu %}fas{% else %}far{% endif %} fa-heart text-xl"></i>
                    <span class="count-foto text-xs ml-1">{{ midia.curtidas_recebidas.count }}</span>
                </button>
                {% else %}
                <span class="text-silver text-[10px] uppercase">Login para curtir</span>
                {% endif %}

                <span class="text-silver/50 text-[10px]">#{{ midia.id }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-20 bg-surface rounded border border-dashed border-silver/10">
        <p class="text-silver uppercase tracking-widest">Nenhuma imagem disponível nesta galeria.</p>
    </div>
    {% endif %}
</div>

<script>
function toggleCurtida(btn, midiaId) {
    const url = `/galerias/curtir/${midiaId}/`;
    const icon = btn.querySelector('i');
    const countSpan = btn.querySelector('.count-foto');

    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'adicionado') {
            icon.classList.remove('far');
            icon.classList.add('fas');
            btn.classList.add('text-primary-purple');
            btn.classList.remove('text-white');
        } else {
            icon.classList.remove('fas');
            icon.classList.add('far');
            btn.classList.remove('text-primary-purple');
            btn.classList.add('text-white');
        }
        countSpan.textContent = data.total_foto;
    })
    .catch(error => console.error('Erro:', error));
}
</script>
{% endblock %}