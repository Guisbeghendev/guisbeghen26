{% extends 'base.html' %}

{% block title %}{{ sala.nome_exibicao }} - GUISBEGHEN{% endblock %}

{% block content %}
<div class="container mx-auto px-4 lg:px-8 py-6 lg:py-12">
    <div class="flex items-center justify-between mb-6 lg:mb-8">
        <h1 class="text-xl lg:text-3xl font-bold text-primary-purple uppercase tracking-tighter">Chat: {{ sala.nome_exibicao }}</h1>
        <a href="{% url 'mensagens:lista_salas' %}" class="text-silver hover:text-white transition-colors text-[10px] lg:text-sm uppercase tracking-widest font-bold">
            <i class="fas fa-arrow-left mr-1 lg:mr-2"></i> Voltar
        </a>
    </div>

    <div class="flex flex-col lg:flex-row gap-4 lg:gap-6 h-auto lg:h-[600px]">

        {# Area do Chat #}
        <div class="flex-1 bg-black border border-silver/10 rounded-lg flex flex-col order-1 lg:order-2 h-[500px] lg:h-full">
            {# Area de Mensagens #}
            <div id="chat-log" class="flex-1 overflow-y-auto p-4 lg:p-6 space-y-4 scrollbar-thin scrollbar-thumb-silver scrollbar-track-black text-sm lg:text-base">
                {% for mensagem in mensagens %}
                    <div class="flex flex-col {% if mensagem.remetente == request.user %}items-end{% else %}items-start{% endif %}">
                        <span class="text-[10px] text-silver uppercase mb-1 font-bold">{{ mensagem.remetente.username }}</span>
                        <div class="max-w-[85%] lg:max-w-[80%] px-3 lg:px-4 py-2 rounded-lg {% if mensagem.remetente == request.user %}bg-primary-blue text-white{% else %}bg-surface text-silver{% endif %}">
                            <p class="text-xs lg:text-sm">{{ mensagem.conteudo }}</p>
                        </div>
                    </div>
                {% endfor %}
            </div>

            {# Input de Mensagem Ajustado para Mobile #}
            <div class="p-3 lg:p-4 border-t border-silver/10 bg-surface rounded-b-lg">
                <div class="flex gap-2 lg:gap-4">
                    <input id="chat-message-input" type="text" placeholder="Mensagem..."
                        class="flex-1 min-w-0 bg-white border border-silver/20 rounded px-3 py-2 text-black text-sm placeholder:text-gray-500 focus:outline-none focus:border-primary-purple transition-colors">
                    <button id="chat-message-submit" class="bg-primary-purple text-white px-4 lg:px-6 py-2 rounded font-bold hover:bg-purple-hover transition-all uppercase tracking-widest text-[10px] lg:text-sm flex items-center shrink-0">
                        <span class="hidden lg:inline mr-2">Enviar</span>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        {# Lista de Usu√°rios #}
        <div class="w-full lg:w-64 bg-black border border-silver/10 rounded-lg flex flex-col order-2 lg:order-1 h-[150px] lg:h-full">
            <div class="p-3 lg:p-4 border-b border-silver/10">
                <h3 class="text-silver font-bold uppercase tracking-widest text-[10px] lg:text-xs">Membros do Grupo</h3>
            </div>
            <div id="user-list" class="flex-1 overflow-y-auto p-3 lg:p-4 space-y-2">
                {# Populado via JS #}
            </div>
        </div>

    </div>
</div>

{{ sala.id|json_script:"sala-id" }}

<script>
    const salaId = JSON.parse(document.getElementById('sala-id').textContent);
    const chatLog = document.querySelector('#chat-log');
    const userListDiv = document.querySelector('#user-list');
    const messageInput = document.querySelector('#chat-message-input');
    const submitButton = document.querySelector('#chat-message-submit');

    chatLog.scrollTop = chatLog.scrollHeight;

    const chatSocket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://')
        + window.location.host
        + '/ws/chat/'
        + salaId
        + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.type === 'chat_message') {
            const isMe = data.user === "{{ request.user.username }}";
            const msgHtml = `
                <div class="flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                    <span class="text-[10px] text-silver uppercase mb-1 font-bold">${data.user}</span>
                    <div class="max-w-[85%] lg:max-w-[80%] px-3 lg:px-4 py-2 rounded-lg ${isMe ? 'bg-primary-blue text-white' : 'bg-surface text-silver'}">
                        <p class="text-xs lg:text-sm">${data.mensagem}</p>
                    </div>
                </div>
            `;
            chatLog.innerHTML += msgHtml;
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        if (data.type === 'user_list') {
            userListDiv.innerHTML = '';
            data.usuarios.forEach(user => {
                const userHtml = `
                    <div class="flex items-center gap-2 text-silver text-xs lg:text-sm">
                        <div class="w-1.5 h-1.5 lg:w-2 lg:h-2 rounded-full bg-green-500"></div>
                        <span class="font-medium uppercase tracking-wider text-[10px] lg:text-[11px]">${user}</span>
                    </div>
                `;
                userListDiv.innerHTML += userHtml;
            });
        }
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket fechado inesperadamente');
    };

    submitButton.onclick = function(e) {
        const mensagem = messageInput.value;
        if(mensagem.trim() !== "") {
            chatSocket.send(JSON.stringify({
                'mensagem': mensagem
            }));
            messageInput.value = '';
        }
    };

    messageInput.onkeyup = function(e) {
        if (e.keyCode === 13) {
            submitButton.click();
        }
    };
</script>
{% endblock %}